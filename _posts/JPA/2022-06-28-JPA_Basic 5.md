---
title: "[JPA 01. 자바 ORM 표준 JPA 프로그래밍 (객체지향 쿼리 언어 - 기본 문법)]"
categories:
  - JPA
tags:
  - JPA
  # -
toc: true
toc_sticky: true
toc_label: "JPA 01. 자바 ORM 표준 JPA 프로그래밍 (객체지향 쿼리 언어 - 기본 문법)"
toc_icon: "bookmark"
---

<br>

## 객체지향 쿼리 언어 - 기본 문법

### 0. 객체지향 쿼리 언어 소개

> - **JPA는 다양한 쿼리 방법을 지원한다.**
>   - **JPQL** : 실무에서는 대부분 JPQL로 해결 가능
>   - JPA Criteria
>   - **QueryDSL**
>   - 네이티브 SQL
>   - JDBC API 직접 사용, MyBatis, SpringJdbcTemplate

> - **JPQL 소개**
>   - 가장 단순한 조회 방법
>     - EntityManager.find()
>     - 객체 그래프 탐색(a.getB().getC())
>   - **ex) 나이가 18살 이상인 회원을 모두 검색하고 싶다면?**
>     - 단순히 하나를 찍어서 가져올수 있는것이 아니다.

> - **JPQL**
>   - JPA를 사용하면 엔티티 객체를 중심으로 개발
>   - 문제는 검색 쿼리
>   - 검색을 할 때도 **테이블이 아닌 엔티티 객체를 대상으로 검색**
>   - 모든 DB 데이터를 객체로 변환해서 검색하는 것은 불가능
>   - 애플리케이션이 필요한 데이터만 DB에서 불러오려면 결국 검색 조건이 포함된 SQL이 필요
>   - **위에 언급된 문제들을 해결하기 위해** JPA는 SQL을 추상화한 JPQL이라는 객체 지향 쿼리 언어 제공
>   - SQL과 문법 유사, SELECT, FROM, WHERE, GROUP BY, HAVING, JOIN 지원
>   - JPQL은 엔티티 객체를 대상으로 쿼리
>   - SQL은 데이터베이스 테이블을 대상으로 쿼리
>   - 테이블이 아닌 객체를 대상으로 검색하는 객체지향 쿼리
>   - SQL을 추상화해서 특정 데이터베이스 SQL에 의존X
>   - JPQL을 한마디로 정의하면 객체지향 SQL
>   - JPQL은 단순 문자이기 때문에 동적 쿼리를 만들기 매우 어렵다.

```java
//간단한 JPQL의 예
List<Member> result = em.createQuery(
                    "select m From Member m where m.age > 18",
                    Member.class
).getResultList();

//실행된 SQL
select
    m.id as id,
    m.age as age,
    m.USERNAME as USERNAME,
    m.TEAM_ID as TEAM_ID
from
    Member m
where
    m.age>18
```

> - **Criteria 소개**
>   - 문자가 아닌 자바코드로 JPQL을 작성할 수 있음
>   - 쿼리문에서 오타를 내도 컴파일 시점에서 잡아준다
>   - JPQL 빌더 역할
>   - JPA 공식 기능
>   - **단점 : 너무 복잡하고 실용성이 없다.**
>     - 유지보수가 어려움
>     - sql 같지가 않음
>     - 디버깅을 못함
>   - Criteria 대신에 **QueryDSL** 사용 권장

```java
//Criteria 사용 준비
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);
//루트 클래스 (조회를 시작할 클래스)
Root<Member> m = query.from(Member.class);
//쿼리 생성
CriteriaQuery<Member> cq = query.select(m).where(cb.equal(m.get("username"), "kim"));
List<Member> resultList = em.createQuery(cq).getResultList();
```

> - **QueryDSL 소개**
>   - 문자가 아닌 자바코드로 JPQL을 작성할 수 있음
>   - JPQL 빌더 역할
>   - 컴파일 시점에 문법 오류를 찾을 수 있음
>   - 동적쿼리 작성 편리함
>   - **단순하고 쉬움**
>   - **실무 사용 권장**

```java
//JPQL
//select m from Member m where m.age > 18
JPAFactoryQuery query = new JPAQueryFactory(em);
QMember m = QMember.member;
List<Member> list =
        query.selectFrom(m)
                .where(m.age.gt(18))
                .orderBy(m.name.desc())
                .fetch();
```

> - **네이티브 SQL 소개**
>   - JPA가 제공하는 SQL을 직접 사용하는 기능
>   - JPQL로 해결할 수 없는 특정 데이터베이스에 의존적인 기능
>   - 예) 오라클 CONNECT BY, 특정 DB만 사용하는 SQL 힌트

```java
em.createNativeQuery("select MEMBER_ID, city, street, zipcode, USERNAME from MEMBER").getResultList();
```

> - **JDBC 직접 사용, SpringJdbcTemplate 등**
>   - JPA를 사용하면서 JDBC 커넥션을 직접 사용하거나, 스프링 JdbcTemplate, MyBatis 등을 함께 사용 가능
>   - 단 영속성 컨텍스트를 적절한 시점에 강제로 플러시 필요
>   - 예) JPA를 우회해서 SQL을 실행하기 직전에 영속성 컨텍스트 수동 플러시

## Quiz

**문제 1.** 다음 예제들의 성공 여부를 쓰시오.

```java
예제 1. select o.member.team
        from Order o

예제 2. select t.members from Team

예제 3. select t.members.username from Team t

예제 4. select m.username from Team t join t.members m
```

<details>
<summary>정답 확인</summary>
<div markdown="1">
<br>
<h1>1. 성공</h1> <br> 
<h1>2. 성공</h1> <br> 
<h1>3. 실패</h1> <br>
<h1>4. 성공</h1> <br>

실패 이유 : 컬렉션에서는 더 들어가면 안된다. 명시적 조인을 통해 별칭을 얻어야한다. <br>

<br>
</div>
</details>
<br>
